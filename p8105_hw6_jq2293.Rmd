---
title: "p8105_hw6_jq2293"
author: "JiyueQin"
date: "November 24, 2018"
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
theme_set(theme_bw())
knitr::opts_chunk$set(dpi = 200, out.width = "90%")
```

# Problem 1

This problem uses dataset about homicides in 50 large US cities.

## import and tidy

First, import the data from website and do some cleaning.

```{r tidy, message = FALSE}
homicide_data = read_csv("https://github.com/washingtonpost/data-homicides/raw/master/homicide-data.csv") %>% 
  unite(city_state, city, state, sep = ",", remove = FALSE) %>% 
  mutate(solved = as.numeric(disposition == "Closed by arrest")) %>% 
  filter(! city %in% c("Dallas","Phoenix","Kansas City") &
           city_state != "Tulsa,AL") %>% 
  mutate(victim_race = recode_factor(victim_race, White = "white", .default = "non-white"),
         victim_age = as.numeric(victim_age))
```

The initial cleaning steps include:

1. using `unite()` to add a new variable `city_state`.

2. using `mutate()` to add a new variable `solved`.

3. using `filter()` to remove observations in certain cities which lack inforation of victim race.

4. using `mutate()` to modify `victim_race` into categories of white and non-white and convert `victim_age` into numeric variable.

The resulting dataset `homicide_data` has `r nrow(homicide_data)` rows and `r ncol(homicide_data)` columns.

Some key variables are:

- `victim_race`: factor variable, white as reference.

- `city_state`: character varibale, denotes the place of the crime.  

- `lat` and `lon`: numeric variable, denotes the geo location of the crime.

- `solved`: numeric variable(binary), 1 denotes the crime is sloved, meaning closed by arrest. Otherwise, take 0.

## regression for Baltimore

Then, fit a logistic regression to the records in Baltimore. Outcome is resolved vs unresolved and predictors are victim age, sex and race. 

```{r reg}
fit_logit_Bal =
  homicide_data %>% 
  filter(city == "Baltimore") %>% 
  glm(solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) 

fit_logit_Bal %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         term = str_replace(term, "sex", "sex:"),
         term = str_replace(term, "race", "race:"))%>%
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)
  
result = confint(fit_logit_Bal) %>%
  as.data.frame() %>%
  mutate(term = row.names(.)) %>% 
  full_join(., broom::tidy(fit_logit_Bal), by = "term") %>% 
  select(term, log_OR = estimate, lower_log_OR = "2.5 %", upper_log_OR = "97.5 %") %>% 
  mutate(OR = exp(log_OR),
         lower_OR = exp(lower_log_OR),
         upper_OR = exp(upper_log_OR),
         term = str_replace(term, "sex", "sex:"),
         term = str_replace(term, "race", "race:"))

 knitr::kable(result, digits = 3)
```

From the results of the regression, we can see age, sex and race are all significant predictors at 0.05 level.

For solving homicides, comparing non-white victims to white victims keeping all other variables fixed, the estimated odds ratio is `r round(result[4, 5], 3)`, the 95% confidence is (`r round(result[4, 6], 3)`, `r round(result[4, 7], 3)`). Here, odds ratio is computed using `exp()` to transform original estimate. Smae for the confidence interval.

This indicates non-white victims are more likely to have unsolved homicides than white victims. 

## regression for each city

Run glm for each of the cities and compute estimated ORs and CIs.

```{r reg_all, warning = FALSE, message = FALSE}
summary_reg = function(dataset){
  fit = glm(solved ~ victim_age + victim_sex + victim_race, data = dataset, family = binomial())
  confint(fit) %>%
  as.data.frame() %>%
  mutate(term = row.names(.)) %>% 
  full_join(., broom::tidy(fit), by = "term") %>% 
  select(term, log_OR = estimate, lower_log_OR = "2.5 %", upper_log_OR = "97.5 %") %>% 
  mutate(OR = exp(log_OR),
         lower_OR = exp(lower_log_OR),
         upper_OR = exp(upper_log_OR)) %>% 
  filter(term == "victim_racenon-white")

}

race_estimate = homicide_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(result = map(data, summary_reg)) %>% 
  select(-data) %>% 
  unnest() %>% 
  select(-term)
  
 knitr::kable(head(race_estimate), digits = 3)
```

## plot

Finally, a plot is generated to visualize the adjusted odds ratios for non-white victims compared to white victims.

```{r plot}
race_estimate %>% 
  ggplot(aes(x = forcats::fct_reorder(city_state, OR), color = city_state)) +
  geom_point(aes(y = OR)) +
  geom_errorbar(aes(ymin = lower_OR, ymax = upper_OR)) +
  coord_flip() +
  labs(x = "",
       y = "estimated odds ratio",
       title = "adjusted ORs of solving homicides in non-white victims vs whites in 50 cities",
       caption = "error bar showing 95% confidence interval") + 
  theme_bw(base_size = 8) +
  theme(legend.position = "None")
```

From the plot, we can see Boston has the lowest odds ratio(less than 0.25), meaning in Boston, non-white victims are much less likely to have solved homicides compared to white victims.  Tampa, Birmingham and Durham have Top3 highest odds ratio, which are a bit higher than 1, meaning the probability of getting a solved homicide is similar between non-whites and whites.

About half of the cities have confidence intervals smaller than 1, which indicates in these cities, race is a significant predictor of solved/unsolved homicide at 0.05 level.